<%- include('../layouts/header.ejs') %>
<%- include('../layouts/userNav.ejs') %>
<%- include('../layouts/userTopbar.ejs') %>



<main class="main">
    <div class="page-header text-center" style="height: 10px;  background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h3 class="page-title">CHECKOUT</h3>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/cartPage">Cart</a></li>
                <li class="breadcrumb-item active" aria-current="page">Checkout</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                <div class="checkout-discount">
                    <form action="/coupon">
                        <input type="text" class="form-control" required id="checkout-discount-input">
                        <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
                    </form>
                </div><!-- End .checkout-discount -->

                <form id="checkout-form" action="/placeOrder" method="post">
                    <div class="row">
                        <div class="col-lg-8">
                            <% if(addressDoc && addressDoc[0].address.length > 0){  %>
                                <% for (var i = 0; i < addressDoc[0].address.length; i += 2) { %>
                                    <div class="row">
                                        <% for (var j = i; j < i + 2 && j < addressDoc[0].address.length; j++) { %>
                                            <div class="col-md-6 mb-3">
                                                <div class="card card-dashboard address-card" id="address-<%= j %>">
                                                    <div class="card-body">
                                                        <label>
                                                            <input type="radio" name="addressId" value="<%= addressDoc[0].address[j]._id %>" class="toggle-address-details" data-target="#address-details-<%= j %>" <% if (j === 0) { %> checked <% } %>/>
                                                            
                                                        </label>
                                                        <h6>Address <%= j + 1 %></h6>
                                                        <p><strong>Name: <%= addressDoc[0].address[j].name %><br></strong> 
                                                        Phone: <%= addressDoc[0].address[j].phone %><br>
                                                        Pincode: <%= addressDoc[0].address[j].pincode %>,
                                                        State: <%= addressDoc[0].address[j].state %><br>
                                                        City: <%= addressDoc[0].address[j].city %>,
                                                        Street: <%= addressDoc[0].address[j].street %></p>
                                                    </div><!-- End .card-body -->
                                                </div><!-- End .card-dashboard -->
                                            </div><!-- End .col-md-6 -->
                                        <% } %>
                                    </div><!-- End .row -->
                                <% } %>
                            <% } else {  %>
                                <p>No existing address</p>
                            <% } %>
                        </div><!-- End .col-lg-8 -->
                        
                        
                        <aside class="col-lg-4">
                            <div class="summary">
                                <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->
                                <% let total = cart.product.reduce((acc, data) => acc + (data.quantity * data.productId.price), 0) %>

                                <table class="table table-summary">
                                    <tbody>
                                        <!-- Existing summary content -->
                                        <tr class="summary-subtotal">
                                            <td>Subtotal:</td>
                                            <td>₹<%= total %></td>
                                        </tr><!-- End .summary-subtotal -->
                                        <tr>
                                            <td>Shipping:</td>
                                            <td>Free shipping</td>
                                        </tr>
                                        <tr class="summary-total">
                                            <td>Total:</td>
                                            <td>₹<%= total %></td>
                                        </tr><!-- End .summary-total -->
                                    </tbody>
                                </table><!-- End .table table-summary -->
                                <!-- Hidden input to transfer the total value -->
                                <input type="hidden" name="total" value="<%= total %>">
                        
                                <!-- Payment options radio buttons -->
                                <div class="payment-options">
                                    <div class="form-group">
                                        <label class="payment-option">
                                            <input type="radio" name="paymentOption" value="Cash On Delivery" checked>
                                            Cash On Delivery
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="payment-option">
                                            <input type="radio" name="paymentOption" value="Razorpay">
                                            Razorpay
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="payment-option">
                                            <input type="radio" name="paymentOption" value="Wallet">
                                            Wallet
                                        </label>
                                    </div>
                                </div><!-- End .payment-options -->
                        
                                <button id="placeOrderBtn" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">Place Order</button>

                            </div><!-- End .summary -->
                        </aside><!-- End .col-lg-4 -->
                        
                    </div><!-- End .row -->
                </form>

                <div class="col-lg-9">
                    <a href="#tab-address" id="shipToNewAddressBtn" class="btn btn-primary mb-4">Ship to New Address</a>
                
                   
                
                    
                
                </div><!-- End .col-lg-9 -->


            </div><!-- End .container -->
        </div><!-- End .checkout -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

<%- include('../layouts/footer.ejs') %>




<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('checkout-form');
       
    
        form.addEventListener('submit', function(event) {
            event.preventDefault();
    
            const formData = new FormData(form);
            const data = {};
    
            formData.forEach((value, key) => {
                data[key] = value;
            });
    
            axios.post('/placeOrder', data)
                .then(response => {
                    if (response.status === 200) {
                        window.location.href = '/orderSuccesfulPage';
                    } else {
                        alert('There was an error placing the order!');
                    }
                })
                .catch(error => {
                    console.error('There was an error placing the order!', error);
                    alert('There was an error placing the order!');
                });
        });
    });
    </script>
    
