<%- include('../layouts/adminHeader.ejs') %>

<!-- Layout Wrapper -->
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <!-- Layout Page -->
    <div class="layout-page">
      <!-- Navbar -->
      <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
          <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
            <i class="bx bx-menu bx-sm"></i>
          </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
          <!-- Search -->
          <div class="navbar-nav align-items-center">
            <div class="nav-item d-flex align-items-center">
              <i class="bx bx-search fs-4 lh-0"></i>
              <input type="text" class="form-control border-0 shadow-none" placeholder="Search..." aria-label="Search..." />
            </div>
          </div>
          <!-- /Search -->

          <ul class="navbar-nav flex-row align-items-center ms-auto">
            <!-- GitHub Star Button -->
            <li class="nav-item lh-1 me-3">
              <a class="github-button" href="#" data-icon="octicon-star" data-size="large" data-show-count="true">Star</a>
            </li>

            <!-- User Dropdown -->
            <li class="nav-item navbar-dropdown dropdown-user dropdown">
              <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                <div class="avatar avatar-online">
                  <img src="/admin/assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                </div>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <div class="d-flex">
                      <div class="flex-shrink-0 me-3">
                        <div class="avatar avatar-online">
                          <img src="/admin/assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                        </div>
                      </div>
                      <div class="flex-grow-1">
                        <span class="fw-semibold d-block">PR</span>
                        <small class="text-muted">Admin</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li><div class="dropdown-divider"></div></li>
                <li><a class="dropdown-item" href="#"><i class="bx bx-user me-2"></i>My Profile</a></li>
                <li><a class="dropdown-item" href="#"><i class="bx bx-cog me-2"></i>Settings</a></li>
                <li>
                  <a class="dropdown-item" href="#">
                    <span class="d-flex align-items-center align-middle">
                      <i class="flex-shrink-0 bx bx-credit-card me-2"></i>
                      <span class="flex-grow-1 align-middle">Billing</span>
                      <span class="flex-shrink-0 badge badge-center rounded-pill bg-danger w-px-20 h-px-20">4</span>
                    </span>
                  </a>
                </li>
                <li><div class="dropdown-divider"></div></li>
                <li><a class="dropdown-item" href="auth-login-basic.html"><i class="bx bx-power-off me-2"></i>Log Out</a></li>
              </ul>
            </li>
            <!-- /User Dropdown -->
          </ul>
        </div>
      </nav>
      <!-- /Navbar -->

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <!-- Main Content -->
        <div class="container-xxl flex-grow-1 container-p-y">
          <div class="row">
            <!-- Left Column: Badge Notification -->
            <div class="col-lg-10 mb-4 order-0">
              <div class="card shadow-sm">
                <div class="d-flex align-items-end row">
                  <div class="col-sm-7">
                    <div class="card-body">
                      <h5 class="card-title text-primary">Congratulations! ðŸŽ‰</h5>
                      <p class="mb-4">You have done a great job. Check your new badge in your profile.</p>
                      <a href="javascript:;" class="btn btn-sm btn-outline-primary">View Badges</a>
                    </div>
                  </div>
                  <div class="col-sm-5 text-center text-sm-left">
                    <div class="card-body pb-0 px-0 px-md-4">
                      <img src="/admin/assets/img/illustrations/man-with-laptop-light.png" height="140" alt="View Badge User" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="row">
            <!-- First Sales Box -->
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="/admin/assets/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded" />
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt1">
                                    <a class="dropdown-item" href="/admin/Salesreport">View More</a>
                                </div>
                            </div>
                        </div>
                        <span>Sales</span>
                        <h3 class="card-title text-nowrap mb-1">â‚¹<%= totalSale %></h3>
                        <small class="text-success fw-semibold"><i class="bx bx-up-arrow-alt"></i> +Growth%</small>
                    </div>
                </div>
            </div>
        
            <!-- Second Sales Box -->
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="/admin/assets/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded" />
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt2">
                                    <a class="dropdown-item" href="/order/orderDetails">View More</a>
                                </div>
                            </div>
                        </div>
                        <span>Orders</span>
                        <h3 class="card-title text-nowrap mb-1"><%= orders.length %></h3>
                        <small class="text-success fw-semibold"><i class="bx bx-up-arrow-alt"></i> +Growth%</small>
                    </div>
                </div>
            </div>
        
            <!-- Third Sales Box -->
            <div class="col-lg-2 col-md-6 col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="card-title d-flex align-items-start justify-content-between">
                            <div class="avatar flex-shrink-0">
                                <img src="/admin/assets/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded" />
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="cardOpt3" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt3">
                                    <a class="dropdown-item" href="/admin/products">View More</a>
                                </div>
                            </div>
                        </div>
                        <span>Products</span>
                        <h3 class="card-title text-nowrap mb-1"><%= products.length %></h3>
                        <small class="text-success fw-semibold"><i class="bx bx-up-arrow-alt"></i> +Growth%</small>
                    </div>
                </div>
            </div>

            <!-- forrth Sales Box -->
            <div class="col-lg-2 col-md-6 col-12 mb-4">
              <div class="card shadow-sm">
                  <div class="card-body">
                      <div class="card-title d-flex align-items-start justify-content-between">
                          <div class="avatar flex-shrink-0">
                              <img src="/admin/assets/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded" />
                          </div>
                          <div class="dropdown">
                              <button class="btn p-0" type="button" id="cardOpt4" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                  <i class="bx bx-dots-vertical-rounded"></i>
                              </button>
                              <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt3">
                                  <a class="dropdown-item" href="/admin/customer;">View More</a>
                              </div>
                          </div>
                      </div>
                      <span>Users</span>
                      <h3 class="card-title text-nowrap mb-1"><%= usersNo.length %></h3>
                      <small class="text-success fw-semibold"><i class="bx bx-up-arrow-alt"></i> +Growth%</small>
                  </div>
              </div>
          </div>
        </div>
        

          <!-- Total Revenue Section -->
          <div class="row mt-3 mb-4">
            <div class=" col-10 order-2">
              <div class="card shadow-sm">
                <div class="row row-bordered g-0">
                
                  <div class="col-md-12" style="text-align: center; padding: 20px;">
                    <h5 class="card-header m-0 me-2 pb-3">Total Revenue</h5>
                    
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div>
                            <canvas id="myChart" style="height: 300px; width: 100%; max-width: 600px;"></canvas>
                        </div>
                
                        <div class="mt-3">
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    Click Here
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <li><a class="dropdown-item" id="monthly-option"  href="#">Monthly</a></li>
                                    <li><a class="dropdown-item" id="yearly-option"  href="#">Yearly</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                </div>
              </div>
            </div>

          </div>

          <!-- Order Statistics Section -->
          <div class="row mb-4">
            <div class="col-5">
              <div class="card shadow-sm">
                <h5 class="card-header">Top 5 Categories</h5>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="top5categories" class="table table-striped">
                      <thead>
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Category</th>
                          <th scope="col">Orders</th>
                          <th scope="col">Revenue</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if(top5catgry.length>0){ %>
                          <% top5catgry.forEach((val,i)=>{ %>
                        <tr>
                          <th scope="row"><%= i+1 %></th>
                          <td><%= val.categoryName %></td>
                          <td><%= val.count %></td>
                          <td>â‚¹<%= val.totalIncome %></td>
                        </tr>
                        <% }) %>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            

            <div class="col-5">
              <div class="card shadow-sm">
                <h5 class="card-header">Top 5 Products</h5>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="top5products" class="table table-striped">
                      <thead>
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Product</th>
                          <th scope="col">Orders</th>
                          <th scope="col">Revenue</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if(top5Prdt.length>0){ %>
                          <% top5Prdt.forEach((val,i)=>{ %>
                        <tr>
                          <th scope="row"><%= i+1 %></th>
                          <td><%= val.productName %></td>
                          <td><%= val.count %></td>
                          <td><%= val.totalIncome %></td>
                        </tr>
                        <% }) %>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
        <!-- /Main Content -->
      </div>
      <!-- /Content Wrapper -->
    </div>
    <!-- /Layout Page -->
  </div>
</div>

<!-- Additional CSS for Visual Enhancements -->
<style>
.card {
  border-radius: 1rem; /* Rounded corners */
}

.card-title {
  font-weight: 600; /* Bold title */
}

.card-body {
  padding: 1.5rem; /* Increased padding for card content */
}

.card-header {
  background: linear-gradient(90deg, rgba(0, 123, 255, 0.1), rgba(0, 123, 255, 0.05)); /* Gradient background */
  color: #007bff; /* Custom color for header */
}

.card:hover {
  transform: translateY(-5px); /* Elevation effect on hover */
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* Shadow on hover */
  transition: transform 0.3s, box-shadow 0.3s; /* Smooth transition */
}

.navbar {
  border-bottom: 2px solid rgba(0, 0, 0, 0.1); /* Underline effect for navbar */
}

input.form-control {
  border-radius: 1rem; /* Rounded input */
}

input.form-control:focus {
  box-shadow: 0 0 0.25rem rgba(0, 123, 255, 0.5); /* Focus shadow */
}
</style>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
 let chartInstance = null;
    const ctx = document.getElementById('myChart').getContext('2d');
    
    // Save the initial width and height
    const initialCanvasWidth = ctx.canvas.width;
    const initialCanvasHeight = ctx.canvas.height;

    function destroyChart() {
        if (chartInstance) {
            chartInstance.destroy();
        }
    }

    function yearlyReport(){
        fetch('/order/yearlyReport')
            .then(response => response.json())
            .then(data => {
                const yearlyData = data.yearlyReport.map(item => ({
                    year: item._id.year,
                    totalIncome: item.totalIncome
                }));

                destroyChart();

                // Reset canvas dimensions to their initial values
                ctx.canvas.width = initialCanvasWidth;
                ctx.canvas.height = initialCanvasHeight;

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: yearlyData.map(item => item.year),
                        datasets: [{
                            label: 'Total Income',
                            data: yearlyData.map(item => item.totalIncome),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }

    function monthlyReport(){
        fetch('/order/monthlyReport')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const monthsOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const sortedData = data.orderMonth.sort((a, b) => {
                    return monthsOrder.indexOf(a.monthName) - monthsOrder.indexOf(b.monthName);
                });

                destroyChart();

                // Reset canvas dimensions to their initial values
                ctx.canvas.width = initialCanvasWidth;
                ctx.canvas.height = initialCanvasHeight;

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedData.map(row => row.monthName),
                        datasets: [{
                            label: 'Revenue',
                            data: sortedData.map(row => row.totalIncome),
                            borderColor: 'rgb(255, 124, 124)',
                            backgroundColor: 'rgb(255, 124, 124)',
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        monthlyReport();
    });

    document.getElementById("monthly-option").addEventListener("click", function() {
        monthlyReport();
    });

    document.getElementById("yearly-option").addEventListener("click", function() {
        yearlyReport();
    });
   
</script>

<%- include('../layouts/adminFooter.ejs') %>
